import{showErrorMsg}from"../../common/tools";import{mapStyle}from"../../common/mapstyles";import{AddLegendControl}from"../shared/legend";import{AddSearchControl}from"../shared/searchcontrol";import{Codelist}from"../../common/codelists";import{idNumberFormat,dateFormat_dMY}from"../../common/tools";import{AddSwitcherControl}from"../shared/layerswitcher";var OverviewCtrl={viewId:"overview-cnt",refreshView:!1,sridChanged:!1,switchBasemap:!1,navMap:null,mosaicLayer:null,conflictsLayer:null,spatialunitsLayer:null,boundaryStatusLayer:null,timelineWMSLayer:null,spatialunitConceptsLayer:null,selectInteraction:null,refreshZoom:!1,mapRendered:!1,initMap:function(e){this.navMap=e,this.navMap.on("click",function(e){0==OverviewCtrl.navMap.getFeaturesAtPixel(e.pixel).length&&$$("ovw:infopanel").collapse()}),this.mosaicLayer=new ol.layer.Tile({source:new ol.source.TileWMS,title:"Mosaic",name:"mosaic",switcher:!0,visible:!1}),this.navMap.addLayer(this.mosaicLayer),this.conflictsLayer=new ol.layer.Image({source:new ol.source.ImageWMS,title:"Overlaps",name:"conflcits",switcher:!0,visible:!1}),this.conflictsLayer.setVisible(!1),this.navMap.addLayer(this.conflictsLayer),this.spatialunitsLayer=new ol.layer.Vector({source:new ol.source.Vector,title:"Spatialunits",name:"spatialunits",switcher:!1,style:mapStyle.spatialunitWithLabel("ogc_id",!1)}),this.navMap.addLayer(this.spatialunitsLayer),this.spatialunitsLayer.getSource().on("change",function(){var e;OverviewCtrl.refreshZoom&&(e=OverviewCtrl.spatialunitsLayer.getSource().getExtent(),OverviewCtrl.navMap.getView().setCenter(ol.extent.getCenter(e)),OverviewCtrl.navMap.getView().fit(e,OverviewCtrl.navMap.getSize()),OverviewCtrl.navMap.getView().setZoom(OverviewCtrl.navMap.getView().getZoom()-.2),OverviewCtrl.refreshZoom=!1)}),this.selectInteraction=new ol.interaction.Select({layers:[this.spatialunitsLayer],condition:ol.events.condition.click,style:mapStyle.selectedSpatialunitWithLabel("ogc_id")}),this.navMap.addInteraction(this.selectInteraction),this.selectInteraction.getFeatures().on("add",function(e){OverviewCtrl.onFeatureSelected(e.element)}),this.selectInteraction.getFeatures().on("remove",function(){OverviewCtrl.onFeatureUnselected()}),this.boundaryStatusLayer=new ol.layer.Vector({source:new ol.source.Vector,title:"Boundary Status",name:"boundary_status",switcher:!0,style:mapStyle.boundaryStatus()}),this.boundaryStatusLayer.setVisible(!1),this.navMap.addLayer(this.boundaryStatusLayer),this.spatialunitConceptsLayer=new ol.layer.Vector({source:new ol.source.Vector,name:"spatialunit_concepts",switcher:!1,style:mapStyle.spatialunitConcepts()}),this.navMap.addLayer(this.spatialunitConceptsLayer),this.timelineWMSLayer=new ol.layer.Image({source:new ol.source.ImageWMS,name:"timelinewms",switcher:!1,visible:!1}),this.navMap.addLayer(this.timelineWMSLayer),this.timelineLayer=new ol.layer.Vector({source:new ol.source.Vector,title:"Timeline",name:"timeline",switcher:!0,style:mapStyle.spatialunitConcepts()}),this.timelineLayer.setVisible(!1),this.navMap.addLayer(this.timelineLayer);e="ovw";AddLegendControl(this.navMap,e),AddSearchControl(this.navMap,e,"onSelectionFromSearch"),AddSwitcherControl(this.navMap,e),$$("ovw:timeline_checkbox").attachEvent("onChange",function(e){1==e&&OverviewCtrl.showTimeline()}),this.mapRendered=!0},onViewShow:function(){if(this.switchBasemap&&($$("ovw:navmap").navMap.setBasemap(appdata.basemap),this.switchBasemap=!1),this.sridChanged&!this.refreshView&&(1==this.selectInteraction.getFeatures().getArray().length&&webix.message({type:"success",text:__("Some values were recalculated to reflect the SRID change"),expire:2e3}),this.sridChanged=!1),this.refreshView){this.mapRendered||this.initMap($$("ovw:navmap").navMap),this.spatialunitsLayer.getSource().clear(),this.selectInteraction.getFeatures().clear(),$$("ovw:infopanel").collapse();for(var e of $$("ovw:layer_switcher").queryView({view:"checkbox"},"all"))e.setValue(0),e.config.layer.setVisible(!1);appdata.mosaic?(this.mosaicLayer.setSource(new ol.source.TileWMS({url:appdata.wmsUrl,params:{LAYERS:"mosaic",TILED:!0,MOSAIC:"mosaic_"+appdata.dbparams.database.toLowerCase()}})),this.mosaicLayer.setVisible(!0),$$("ovw:mosaic_checkbox").show(),$$("ovw:mosaic_checkbox").setValue(1)):($$("ovw:mosaic_checkbox").hide(),$$("ovw:mosaic_checkbox").setValue(0)),this.conflictsLayer.setSource(new ol.source.ImageWMS({url:appdata.wmsUrl,params:{LAYERS:"conflicts",TILED:!0}})),this.refreshZoom=!0,webix.ajax().get(appdata.wfsUrl+"&typename=ffp:spatialunit").then(function(e){e=(new ol.format.GeoJSON).readFeatures(e.json());OverviewCtrl.spatialunitsLayer.getSource().addFeatures(e)}),this.boundaryStatusLayer.setSource(new ol.source.Vector({format:new ol.format.GeoJSON,url:appdata.wfsUrl+"&typename=ffp:boundary_status"})),this.timelineWMSLayer.setSource(new ol.source.ImageWMS({url:appdata.wmsUrl,params:{LAYERS:"boundary_status",TILED:!0}})),$$("ovw:search_combo").getList().config.dataFeed="api/spatialunit/search/?"+appdata.querystring,this.refreshView=!1,this.sridChanged=!1}},onSelectionFromSearch:t=>{var e=OverviewCtrl.spatialunitsLayer.getSource().getFeatures().filter(e=>e.getProperties().ogc_id==t);OverviewCtrl.featureFromSearch=!0,OverviewCtrl.selectInteraction.getFeatures().clear(),OverviewCtrl.selectInteraction.getFeatures().push(e[0])},onFeatureSelected:e=>{var r=e.get("ogc_id");OverviewCtrl.featureFromSearch&&(t=OverviewCtrl.selectInteraction.getFeatures().getArray()[0].getGeometry().getExtent(),OverviewCtrl.navMap.getView().setCenter(ol.extent.getCenter(t)),OverviewCtrl.featureFromSearch=!1),OverviewCtrl.spatialunitConceptsLayer.setSource(new ol.source.Vector({format:new ol.format.GeoJSON,url:appdata.wfsUrl+"&typename=ffp:boundary_status&SU_ID="+r}));var t={su_id:r,srid:appdata.srid};webix.ajax().get("api/spatialunit/full/",{...appdata.dbparams,...t}).then(function(t){if(t.json().success){$$("ovw:infopanel").expand();var a=t.json();let e=a.details;var i=Number(e.area_m2)<9e3?e.area_m2+"&nbsp;m<sup>2</sup>":(Number(e.area_m2)/1e4).toFixed(1)+"&nbsp;has";$$("ovw:su_details").setValues({"ovw:details_suid":e.objectid,"ovw:details_label":e.su_label,"ovw:details_area":i,"ovw:details_landuse":Codelist("landuse",e.landuse),"ovw:details_physicalid":e.physical_id?e.physical_id.join(", "):"","ovw:details_legalid":e.legal_id||"","ovw:details_surveyedon":dateFormat_dMY(e.surveyed_on)});var s=[{type:"label",css:"property_label",label:__("Rightholders")}];0==a.parties.length?s.push({type:"text",label:""}):($$("ovw:su_details").setValues({"ovw:details_rigthtype":Codelist("righttype",a.parties[0].right_type)},!0),a.parties.forEach(function(e){s.push({type:"text",css:"property_value",label:e.id_number?idNumberFormat(e.id_number):"~",value:e.full_name})})),webix.ui({view:"property",id:"ovw:su_parties",autoheight:!0,editable:!1,nameWidth:120,tooltip:"#value#",elements:s},$$("ovw:infopanel_body"),$$("ovw:su_parties"));s=[{type:"label",css:"property_label",label:__("Neighbours")}];0==a.neighbours.length?s.push({type:"text",label:""}):a.neighbours.forEach(function(e){s.push({type:"text",css:"property_value",label:e.neigh_suid,value:e.neigh_name})});i={view:"property",id:"ovw:su_neighbours",autoheight:!0,editable:!1,nameWidth:50,elements:s};webix.ui(i,$$("ovw:infopanel_body"),$$("ovw:su_neighbours"));s=[{type:"label",css:"property_section_label",label:__("Boundary Status")}];a.status.forEach(function(e){var t;s.push({type:"label",css:"property_label",label:r+" &ndash; "+e.su_id}),e.status_list.forEach(function(e){t=1==e.status?'<i class="mdi mdi-check-bold" style="color:#32CD32"></i>':0==e.status?'<i class="mdi mdi-cancel" style="color:#DC143C"></i>':'<i class="mdi mdi-help"></i>',s.push({type:"text",css:"property_boolean",label:t,value:e.party_name})})});i={view:"property",id:"ovw:su_boundaries",autoheight:!0,editable:!1,nameWidth:40,elements:s};webix.ui(i,$$("ovw:infopanel_body"),$$("ovw:su_boundaries"))}else showErrorMsg(null,t.json().message)},e=>{showErrorMsg(e,"")})},onFeatureUnselected:()=>{OverviewCtrl.spatialunitConceptsLayer.getSource().clear(),$$("ovw:su_details").setValues({"ovw:details_suid":"","ovw:details_label":"","ovw:details_area":"","ovw:details_landuse":"","ovw:details_rigthtype":"","ovw:details_surveyedon":""});var e={view:"property",id:"ovw:su_parties",autoheight:!0,editable:!1,elements:[{type:"label",css:"property_section_label",label:"&nbsp;"+__("Rightholders")},{type:"text",label:""}]};webix.ui(e,$$("ovw:infopanel_body"),$$("ovw:su_parties"));e={view:"property",id:"ovw:su_neighbours",autoheight:!0,editable:!1,elements:[{type:"label",css:"property_section_label",label:"&nbsp;"+__("Neighbours")},{type:"text",label:""}]};webix.ui(e,$$("ovw:infopanel_body"),$$("ovw:su_neighbours"));e={view:"property",id:"ovw:su_boundaries",autoheight:!0,editable:!1,elements:[{type:"label",css:"property_section_label",label:"&nbsp;"+__("Neighbours")},{type:"text",label:""}]};webix.ui(e,$$("ovw:infopanel_body"),$$("ovw:su_boundaries"))},showTimeline:()=>{var e;appdata.timeline?(e=appdata.wfsUrl+"&typename=ffp:timeline&condition=where status<>1",$$("ovw:layer_switcher").hide(),webix.ajax().get(e).then(function(e){var t=(new ol.format.GeoJSON).readFeatures(e.json());$$("nav:sidebar").disable(),$$("ovw:infopanel").disable(),$$("ovw:layer_switcher").disable(),$$("ovw:search_box").disable(),OverviewCtrl.selectInteraction.setActive(!1),OverviewCtrl.timelineWMSLayer.setVisible(!0);var a=0;var i=setInterval(function(){OverviewCtrl.timelineLayer.getSource().addFeature(t[a]),a==t.length-1?(clearInterval(i),setTimeout(()=>{webix.message({type:"success",text:__("Timeline animation completed!!!"),expire:1e3}),OverviewCtrl.timelineLayer.getSource().clear(),OverviewCtrl.timelineWMSLayer.setVisible(!1),$$("nav:sidebar").enable(),$$("ovw:infopanel").enable(),$$("ovw:layer_switcher").enable(),$$("ovw:search_box").enable(),OverviewCtrl.selectInteraction.setActive(!0),$$("ovw:timeline_checkbox").setValue(0)},2e3)):a++},30)})):(webix.message({type:"info",text:__("No timeline records available yet!!!"),expire:1e3}),$$("ovw:timeline_checkbox").setValue(0))}};export{OverviewCtrl};