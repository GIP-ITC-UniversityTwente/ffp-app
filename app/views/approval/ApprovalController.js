import{Codelist}from"../../common/codelists";import{mapStyle}from"../../common/mapstyles";import{uuidv4,attachmentTemplate,showErrorMsg,dateFormat_dMY,FingerprintReader}from"../../common/tools";import{FileUploader,ImageCapture}from"../../common/uploader";import{MapCtrl}from"./MapController";var mouseEventStatus=!1,ApprovalCtrl={mapCtrl:MapCtrl,refreshView:!1,sridChanged:!1,switchBasemap:!0,currentParty:null,partyDataFromDB:!0,checkPartyChecked:!1,approvalParties:new Array,idList:new Array,spatialunitData:null,rightData:null,newAttachments:{facephoto:!1,iddoc:!1,fingerprint:!1},signaturePad:null,signatureWindow:null,signaturePartyId:null,fingerprintSample:null,currSignatureData:null,fingerprintObject:null,showPartyData:function(){var e=this.currentParty;$$("pf-first_name").focus(),$$("apv:party_form").setValues({"pf-first_name":e.first_name,"pf-last_name":e.last_name,"pf-date_of_birth":e.date_of_birth?new Date(e.date_of_birth):"","pf-id_number":e.id_number||"","pf-gender":e.gender,"pf-phone_number":e.phone_number||"","pf-date_checked":e.checked_on?1:0}),this.currentParty.alreadyChecked=!!e.checked_on,$$("apv:party_form").clearValidation();let t;e.checked_on?(t="<b>"+e.checked_on+"</b>",$$("pf:identity_checked").enable()):(t='<span class="pending">&nbsp; <i>'+__("Pending")+"...</i></span>",$$("pf:identity_checked").disable()),$$("pf-date_checked").define("labelRight",__("Data checked on: ")+t),$$("pf-date_checked").refresh();var a=new Array;if(e.face_photo){for(var r of e.face_photo)a.push({data:{type:"",src:"api/attachment/?"+appdata.querystring+"&att_class=party&global_id="+r,alt:r,class:"party",new:!1},template:attachmentTemplate,css:"party_attachment_cnt"});webix.ui(a,$$("pf:facephoto_carousel")),ApprovalCtrl.updateCarouselTabBar("pf:facephoto",a.length)}if(a=new Array,e.id_doc){for(var i of e.id_doc)a.push({data:{type:"",src:"api/attachment/?"+appdata.querystring+"&att_class=party&global_id="+i,alt:i,class:"party",new:!1},tooltip:__("Double click to see original size"),template:attachmentTemplate,css:"party_attachment_cnt"});webix.ui(a,$$("pf:iddoc_carousel")),ApprovalCtrl.updateCarouselTabBar("pf:iddoc",a.length)}$$("pf:edit_btn").enable()},updateCarouselTabBar:(e,t)=>{let a,r,i,n;n="pf:facephoto"==e?"mdi mdi-account-box-multiple":"mdi mdi-card-account-details-outline",r=$$("pf:attachment_tab"),a="&#"+(10102+t-1).toString(),i=r.getOption(e),i.value='<span class="'+n+'">&nbsp;&nbsp;</span><span class="badge">'+a+"</span>",r.refresh()},onEditButtonToggle:function(t,e){var a,r,i,n;e.config.formIsValid?(a=!t,r=$$("apv:party_form").elements,i=Object.keys(r),this.currentParty.alreadyChecked?($$("pf-phone_number").define({readonly:a}),$$("pf-phone_number").refresh(),t?webix.html.addCss($$("pf-phone_number").getNode(),"editable_input"):webix.html.removeCss($$("pf-phone_number").getNode(),"editable_input")):(e.config.formIsValid=!1,i.forEach(function(e){r[e].define({readonly:a}),r[e].refresh(),t?webix.html.addCss(r[e].getNode(),"editable_input"):webix.html.removeCss(r[e].getNode(),"editable_input")}),a?$$("pf-date_checked").disable():$$("pf-date_checked").enable()),t?($$("apv:search_cnt").disable(),$$("pf:cancel_btn").enable(),$$("pf:identity_checked").disable(),1==$$("pf-date_checked").getValue()&&($$("pf:facephoto_btn").enable(),$$("pf:iddoc_btn").enable())):(e.config.formIsValid=$$("apv:party_form").validate(),(n=0!=$$("apv:party_form").getValues()["pf-date_checked"])||0<Object.keys($$("apv:party_form").getDirtyValues()).length?(this.updateParty(n),$$("apv:search_cnt").enable(),$$("pf:cancel_btn").disable(),$$("pf:facephoto_btn").disable(),$$("pf:iddoc_btn").disable()):this.newAttachments.facephoto||this.newAttachments.iddoc?(webix.message({type:"error",expire:2e3,text:__("Cannot save attachments on unchecked party data!!!")}),i.forEach(function(e){r[e].define({readonly:!1}),r[e].refresh(),webix.html.addCss(r[e].getNode(),"editable_input")}),$$("pf-date_checked").enable(),e.toggle()):(webix.message({expire:2e3,text:__("There are no changes to save!!!")}),$$("apv:search_cnt").enable(),$$("pf:cancel_btn").disable(),$$("pf:facephoto_btn").disable(),$$("pf:iddoc_btn").disable(),n&&$$("pf:identity_checked").enable()))):(e.toggle(),console.log("prevented"),webix.message({type:"error",expire:2e3,text:__("You need to provide correct values!!!")}))},onCancelButtonClick:()=>{var form=$$("apv:party_form"),partyData=form.getCleanValues();form.setValues({"pf-first_name":partyData["pf-first_name"],"pf-last_name":partyData["pf-last_name"],"pf-date_of_birth":partyData["pf-date_of_birth"],"pf-id_number":partyData["pf-id_number"],"pf-gender":partyData["pf-gender"],"pf-phone_number":partyData["pf-phone_number"],"pf-date_checked":partyData["pf-date_checked"]}),form.clearValidation();var elements=$$("apv:party_form").elements,fields=Object.keys(elements),carouselViews,removeCode,count;function setCleanCarouselValues(att_type,icon){if(count=0,carouselViews=$$("pf:"+att_type+"_carousel").getChildViews()[0].getChildViews(),1<carouselViews.length){removeCode="";for(var view of carouselViews)view.config.data.new?removeCode+="$$('pf:"+att_type+"_carousel').removeView('"+view.config.id+"');":count++;eval(removeCode)}else{let cols=[{data:{src:"images/blank.gif",alt:""},template:attachmentTemplate}];webix.ui(cols,$$("pf:"+att_type+"_carousel"))}0==count?($$("pf:attachment_tab").getOption("pf:"+att_type).value='<span class="'+icon+'"></span>',$$("pf:attachment_tab").refresh()):ApprovalCtrl.updateCarouselTabBar("pf:"+att_type,count)}fields.forEach(function(e){elements[e].define({readonly:!0}),elements[e].refresh(),webix.html.removeCss(elements[e].getNode(),"editable_input")}),$$("pf-date_checked").disable(),$$("pf:cancel_btn").disable(),$$("pf:facephoto_btn").disable(),$$("pf:iddoc_btn").disable(),$$("apv:search_cnt").enable(),$$("pf:edit_btn").toggle(),$$("pf:edit_btn").config.formIsValid=!0,ApprovalCtrl.partyDataFromDB=!0,ApprovalCtrl.newAttachments.facephoto&&setCleanCarouselValues("facephoto","mdi mdi-account-box-multiple"),ApprovalCtrl.newAttachments.iddoc&&setCleanCarouselValues("iddoc","mdi mdi-card-account-details-outline"),ApprovalCtrl.newAttachments={facephoto:!1,iddoc:!1,fingerprint:!1},ApprovalCtrl.currentParty.alreadyChecked&&$$("pf:identity_checked").enable(),$$("partyform_cnt").config.getController().appEvent=!0,ApprovalCtrl.checkPartyChecked=!1},updateParty:function(t){var e;if(t){(e=$$("apv:party_form").getValues()).face_photos=new Array,e.id_docs=new Array;for(var a of $$("pf:facephoto_carousel").getChildViews()[0].getChildViews())"images/blank.gif"!=a.config.data.src&&e.face_photos.push({globalid:a.config.data.alt,new:a.config.data.new});for(var r of $$("pf:iddoc_carousel").getChildViews()[0].getChildViews())"images/blank.gif"!=r.config.data.src&&e.id_docs.push({globalid:r.config.data.alt,new:r.config.data.new});e.face_photo=$$($$("pf:facephoto_carousel").getActiveId()).data.alt,e.id_doc=$$($$("pf:iddoc_carousel").getActiveId()).data.alt,e.newPhoneNumber=!(!$$("apv:party_form").isDirty()||!this.currentParty.alreadyChecked)}else(e=$$("apv:party_form").getDirtyValues()).newPhoneNumber=!1;e["pf-id_number"]=$$("apv:party_form").getValues()["pf-id_number"],e.known_id=e["pf-id_number"]==this.currentParty.id_number,e.partyChecked=t,e.alreadyChecked=this.currentParty.alreadyChecked,e.oid_list=this.currentParty.oid_list,e.la_partyid=e.alreadyChecked?this.currentParty.globalid:null;var i=$$("apv:party_form").elements;Object.keys(i).forEach(function(e){i[e].define({readonly:!0}),i[e].refresh(),webix.html.removeCss(i[e].getNode(),"editable_input")}),$$("pf-date_checked").disable(),!e.alreadyChecked||this.newAttachments.facephoto||this.newAttachments.iddoc||e.newPhoneNumber?webix.ajax().post("api/party/update/",{...appdata.dbparams,...e}).then(e=>{e.json().success?(t&&$$("pf:identity_checked").enable(),webix.alert({title:"Success",text:__("The changes have been saved..."),ok:"Continue"}).then(()=>{let e=$$("pf:party_search").getList().getSelectedItem();e&&!e.id_number&&(e.id_number=$$("apv:party_form").getValues()["pf-id_number"],$$("pf:party_search").setValue(e.id)),$$("partyform_cnt").config.getController().onPartySelected($$("apv:party_form").getValues()["pf-id_number"],null),ApprovalCtrl.newAttachments={facephoto:!1,iddoc:!1,fingerprint:!1},$$("pf:search_list").getBody().clearAll(),$$("apv:party_form").clearValidation()})):(showErrorMsg(null,e.json().message),$$("partyform_cnt").config.getController().onSuggestHide())},e=>{showErrorMsg(e,"")}):webix.alert({title:"Message",text:__("There are no changes to save!!!"),ok:"Continue"}).then(()=>{$$("pf:identity_checked").enable()})},requestPartyAttachment:e=>{$$("pf:attachment_cnt").setValue("pf:"+e),$$("pf:attachment_tab").setValue("pf:"+e);var t=__("One "+("iddoc"==e?"ID Card":"Face")+" Photo is needed to continue...");t=(t=(t=(t=t.replace("ID card Photo",'<span style="color:lightseagreen;">ID card Photo</span>')).replace("Face Photo",'<span style="color:red;">Face Photo</span>')).replace("Foto de la Cédula",'<span style="color:lightseagreen;">Foto de la Cédula</span>')).replace("Foto del Rostro",'<span style="color:red;">Foto del Rostro</span>');webix.ui({view:"popup",id:"pf:partyphoto_menu",width:50+("en"==appdata.lang)?350:420,modal:!0,position:" center",css:{background:"#e5f3ff"},body:{type:"line",cols:[{view:"icon",icon:"mdi "+("iddoc"==e?"mdi-card-account-details-outline":"mdi-account"),width:50,css:"missing_attachment"},{rows:[{view:"label",label:"<b>"+t+"</b>",align:"center",height:40},{view:"list",data:[{id:"upload_"+e,value:'<i class="mdi mdi-upload" aria-hidden="true"></i>&emsp;'+__("Upload Photo")},{id:"take_"+e,value:'<i class="mdi mdi-camera" aria-hidden="true"></i>&emsp;'+__("Take Photo")},{id:"__cancel__",value:'<i class="mdi mdi-cancel" aria-hidden="true"></i>&emsp;'+__("Cancel")}],template:"#value#",autoheight:!0,select:!0,on:{onAfterSelect:e=>{$$("pf:partyphoto_menu").close(),"__cancel__"!=e?e.includes("upload_")?ApprovalCtrl.uploadAttachment(e):ApprovalCtrl.captureAttachment(e):($$("pf-date_checked").setValue(0),$$("partyform_cnt").config.getController().appEvent=!0)}}}]}]}}).show()},uploadAttachment:e=>{"att_fingerprint"!=(e=e.replace("upload","att"))&&FileUploader.fileDialog({att_type:e,callback:ApprovalCtrl.addPartyAttachment})},addPartyAttachment:function(e,t){var a;"att_facephoto"==t?a=$$("pf:facephoto_carousel"):"att_iddoc"==t&&(a=$$("pf:iddoc_carousel")),a.addView({data:{type:"",src:"images/uploads/"+e+".jpg",alt:e,class:"party",new:!0},tooltip:__("Double click to see original size"),template:attachmentTemplate,css:"party_attachment_cnt"});e=a.getChildViews()[0].getChildViews()[0].config;"images/blank.gif"==e.data.src&&a.removeView(e.id),a.setActiveIndex(a.getChildViews()[0].$view.children.length-1),ApprovalCtrl.updateCarouselTabBar(t.replace("att_","pf:"),a.getChildViews()[0].$view.children.length),ApprovalCtrl.newAttachments[t.replace("att_","")]=!0,ApprovalCtrl.checkPartyChecked&&($$("partyform_cnt").config.getController().appEvent=!0,1==$$("pf:facephoto_carousel").getChildViews()[0].getChildViews().length&&1==$$("pf:iddoc_carousel").getChildViews()[0].getChildViews().length?$$("pf-date_checked").setValue(1):$$("pf-date_checked").setValue(0),ApprovalCtrl.checkPartyChecked=!1)},captureAttachment:e=>{var t;switch(e=e.replace("take","att")){case"att_facephoto":t=__("Face Photo");break;case"att_iddoc":t=__("ID Photo")}var a=ApprovalCtrl.currentParty;ImageCapture.config.params={att_type:e,title:t+__(" of ")+"&rarr; "+a.first_name+" "+a.last_name,callback:ApprovalCtrl.onCameraWindowButtonClick},ImageCapture.show()},onCameraWindowButtonClick:function(e){var t,a,r=document.getElementById("icw-video"),i=document.getElementById("icw-photo"),n="data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7",o=document.getElementById("icw:canvas");"icw:takephoto_btn"==e?(t=r.srcObject.getVideoTracks()[0].getSettings(),o.setAttribute("width",t.width),o.setAttribute("height",t.height),o.getContext("2d").drawImage(r,0,0,t.width,t.height),t=o.toDataURL("image/jpg"),i.setAttribute("src",t),$$("icw:reset_btn").enable(),$$("icw:save_btn").enable(),$$("icw:takephoto_btn").disable()):"icw:reset_btn"==e?(i.setAttribute("src",n),$$("icw:reset_btn").disable(),$$("icw:save_btn").disable(),$$("icw:takephoto_btn").enable()):"icw:cancel_btn"==e?(i.setAttribute("src",n),r.srcObject=null,ImageCapture.config.params={att_type:null,title:null,callback:null},ImageCapture.hide(),ApprovalCtrl.checkPartyChecked&&(1==$$("pf:facephoto_carousel").getChildViews()[0].getChildViews().length&&1==$$("pf:iddoc_carousel").getChildViews()[0].getChildViews().length?$$("pf-date_checked").setValue(1):$$("pf-date_checked").setValue(0),ApprovalCtrl.checkPartyChecked=!1)):"icw:save_btn"==e&&(a=ImageCapture.config.params.att_type,o={globalid:uuidv4(),mode:"capture",attachment_data:o.toDataURL("image/jpg")},webix.ajax().post("api/attachment/capture/",{...appdata.dbparams,...o}).then(function(e){ApprovalCtrl.addPartyAttachment(e.json().globalid,a)}),i.setAttribute("src",n),r.srcObject=null,ImageCapture.config.params={att_type:null,title:null,callback:null},ImageCapture.hide())},onApprovalButtonClick:function(){this.currentParty.validated&&this.approvalParties.push(ApprovalCtrl.currentParty),$$("approval-cnt").setValue("apv:approval"),this.mapCtrl.navMap&&1==this.approvalParties.length&&this.mapCtrl.retrieveSpatialUnits(this.approvalParties[0]),$$("apv:party_grid").clearSelection()},onSpatialunitSelected:function(){$$("apv:partylist_grid").add({id_number:this.currentParty.id_number,full_name:this.currentParty.first_name+" "+this.currentParty.last_name}),$$("apv:approval_forms").show(),$$("apv:map_toolbar").hide();let i=ApprovalCtrl.mapCtrl;i.spatialunitsLayer.setVisible(!1),i.approvalLayer.getSource().addFeature(i.selectionInteraction.getFeatures().getArray()[0].clone()),i.selectionInteraction.setActive(!1),i.rmsInteraction.setActive(!0);var e={su_id:MapCtrl.selectionInteraction.getFeatures().getArray()[0].get("id"),srid:appdata.srid};i.anchorpointsLayer.setSource(new ol.source.Vector({format:new ol.format.GeoJSON,url:appdata.wfsUrl+"&typename=ffp:anchorpoints&SU_ID="+e.su_id})),i.vertexpointsLayer.setSource(new ol.source.Vector({format:new ol.format.GeoJSON,url:appdata.wfsUrl+"&typename=ffp:vertexpoints&SU_ID="+e.su_id})),i.surveypointsLayer.setSource(new ol.source.Vector({format:new ol.format.GeoJSON,url:appdata.wfsUrl+"&typename=ffp:surveypoints&"+new URLSearchParams(e).toString()})),i.conceptsLayer.setSource(new ol.source.Vector({format:new ol.format.GeoJSON,url:appdata.wfsUrl+"&typename=ffp:boundaries&SU_ID="+e.su_id})),$$("apv:layer_switcher").enable(),webix.ajax().get("api/spatialunit/data/",{...appdata.dbparams,...e}).then(function(e){var t,a,r;e.json().success?(ApprovalCtrl.spatialunitData=e.json(),t=ApprovalCtrl.spatialunitData.details,a=Number(t.area_m2)<9e3?t.area_m2+"&nbsp;m<sup>2</sup>":(Number(t.area_m2)/1e4).toFixed(1)+"&nbsp;has",$$("ipg:su_details").setValues({"ipg:details_suid":t.id,"ipg:details_label":null!=t.su_label?t.su_label:"","ipg:details_area":a,"ipg:details_physicalid":null!=t.physical_id?t.physical_id.join(", "):__("---"),"ipg:details_type":null!=t.su_type?Codelist("spatialunittype",t.su_type):__("---")}),$$("apv:party_grid").parse(ApprovalCtrl.spatialunitData.parties),0<ApprovalCtrl.spatialunitData.neighbours.length?($$("apv:neighbours_grid").parse(ApprovalCtrl.spatialunitData.neighbours),r=appdata.wfsUrl+"&typename=ffp:neighbours&SUIDS="+ApprovalCtrl.spatialunitData.neighbours.map(e=>e.neigh_suid),webix.ajax().get(r).then(function(e){e=(new ol.format.GeoJSON).readFeatures(e.json());i.neighboursLayer.getSource().addFeatures(e);e=i.neighboursLayer.getSource().getExtent();i.navMap.getView().setCenter(ol.extent.getCenter(e)),i.navMap.getView().fit(e,i.navMap.getSize()),i.navMap.getView().setZoom(i.navMap.getView().getZoom()-.2)})):(r=i.approvalLayer.getSource().getExtent(),i.navMap.getView().setCenter(ol.extent.getCenter(r)),i.navMap.getView().fit(r,i.navMap.getSize()),i.navMap.getView().setZoom(i.navMap.getView().getZoom()-.2))):showErrorMsg(null,e.json().message)},e=>{showErrorMsg(e,"")})},resetInspectionForms:()=>{ApprovalCtrl.fingerprintSample=null,ApprovalCtrl.signaturePad.clear(),ApprovalCtrl.currSignatureData=null,ApprovalCtrl.signaturePartyId=null,ApprovalCtrl.idList=new Array,ApprovalCtrl.approvalParties=new Array,ApprovalCtrl.spatialunitData=null,ApprovalCtrl.rightData=null,$$("partyform_cnt").config.getController().resetPartyForm(!1),MapCtrl.spatialunitsLayer&&(MapCtrl.spatialunitsLayer.getSource().clear(),MapCtrl.spatialunitsLayer.setVisible(!0),MapCtrl.approvalLayer.getSource().clear(),MapCtrl.neighboursLayer.getSource().clear(),MapCtrl.surveypointsLayer.setSource(new ol.source.Vector),MapCtrl.surveypointsLayer.setVisible(!1),MapCtrl.vertexpointsLayer.setSource(new ol.source.Vector),MapCtrl.vertexpointsLayer.setVisible(!1),MapCtrl.anchorpointsLayer.setSource(new ol.source.Vector),MapCtrl.anchorpointsLayer.setVisible(!0),MapCtrl.conceptsLayer.setSource(new ol.source.Vector),MapCtrl.conceptsLayer.setVisible(!0),MapCtrl.selectionInteraction.getFeatures().clear(),MapCtrl.selectionInteraction.setActive(!0),MapCtrl.rmsInteraction.getFeatures().clear(),MapCtrl.rmsInteraction.setActive(!1),MapCtrl.selectionCount=0,$$("apv:layer_switcher").disable(),$$("apv:anchorpoints_checkbox").setValue(1),$$("apv:vertexpoints_checkbox").setValue(0),$$("apv:surveypoints_checkbox").setValue(0),$$("apv:boundary_concepts_checkbox").setValue(1),$$("apv:layer_switcher").hide()),$$("apv:approval_forms").hide(),$$("apv:map_toolbar").show(),$$("apv:search_cnt").enable(),$$("apv:search_cnt").show(),$$("apv:partylist_grid").clearAll(),$$("apv:party_grid").clearAll(),$$("apv:partylist_cnt").hide(),$$("apv:neighbours_grid").clearAll(),$$("pf:approval_btn").disable(),$$("pf:identity_checked").setValue(!1),$$("pf:identity_checked").disable(),$$("approval-cnt").setValue("apv:identification"),$$("app:srid_form").enable()},onIdCheckButtonClick:e=>{$$("approval-cnt").setValue("apv:identification"),$$("pf:party_search").setValue(" "),$$("pf:identity_checked").setValue(0),$$("pf:approval_btn").disable(),$$("apv:search_cnt").hide(),$$("apv:partylist_cnt").show(),$$("apv:partylist_cnt_label").setHTML(`<b> ${__("Parties already identified for spatialunit number")}: </b>
            ${ApprovalCtrl.spatialunitData.details.id} [
            ${ApprovalCtrl.spatialunitData.details.su_label} ]`),$$("partyform_cnt").config.getController().onPartySelected(e.id_number)},onShowSignForm:function(t){$$("nav:sidebar").disable(),$$("apv:signatures_cnt").config.record=t,$$("apv:approval_forms").setValue("apv:signatures_cnt"),$$("isf:signature-form-header").define({template:__("Boundary Signature Form of")+" &rarr; "+t.full_name}),$$("isf:signature-form-header").refresh();var a=new Object,a={view:"form",id:"isf:concepts_form",scroll:!0,borderless:"true",elements:[]};this.signaturePartyId=t.objectid,this.spatialunitData.concepts.forEach(function(e){e.objectid==t.objectid&&a.elements.push({cols:[{view:"label",label:e.neigh_suid,align:"center",width:40},{view:"label",label:"&ndash;",align:"center",width:10},{view:"label",id:"lbl-"+e.limit_id,label:e.limit_id,tooltip:function(e){var t,a=e.id.replace("lbl-","");return ApprovalCtrl.spatialunitData.boundaries.features.forEach(function(e){e.id==a&&(t=e.properties.length)}),__("Length: ")+t+" m. aprox. ( <em>"+appdata.sridTooltip+"</em> )"},align:"center",width:60,on:{onAfterRender:function(){webix.event(this.$view,"mousemove",function(e){mouseEventStatus||(e=$$(e).config.id.replace("lbl-",""),MapCtrl.setConceptStyle(e,mapStyle.conceptsHover),mouseEventStatus=!0)}),webix.event(this.$view,"mouseout",function(e){mouseEventStatus=!1;e=$$(e).config.id.replace("lbl-","");MapCtrl.setConceptStyle(e,null)})}}},{view:"label",label:"&ndash;",width:20},{view:"label",label:e.neigh_name,width:260},{view:"radio",id:"status-"+e.limit_id,name:"status-"+e.limit_id,width:130,value:null!=e.status?e.status.toString():null,options:[{id:"true",value:__("Yes")},{id:"false",value:__("No")}],on:{onAfterRender:function(){webix.event(this.$view,"mousemove",function(e){mouseEventStatus||(e=$$(e).config.id.replace("status-",""),MapCtrl.setConceptStyle(e,mapStyle.conceptsHover),mouseEventStatus=!0)}),webix.event(this.$view,"mouseout",function(e){mouseEventStatus=!1;e=$$(e).config.id.replace("status-","");MapCtrl.setConceptStyle(e,null)})},onChange:function(){var e=this.config.id.replace("status-","");$$("sign_date-"+e).setValue(dateFormat_dMY(new Date)),$$("apv:signatures_cnt").modified||(webix.html.addCss($$("isf:signature-form-header").getNode(),"modified-value-"+appdata.lang),$$("apv:signatures_cnt").modified=!0,document.getElementById("signature_image").src="images/no-signature.png",ApprovalCtrl.signaturePad.clear(),document.getElementById("fingerprint_image").src="images/no-fingerprint.png",$$("isf:save_btn").enable())}}},{view:"text",id:"sign_date-"+e.limit_id,name:"sign_date-"+e.limit_id,css:"sign_date",width:110,inputWidth:100,value:null==e.sign_date?"":dateFormat_dMY(new Date(e.sign_date)),readonly:!0},{view:"text",id:"remarks-"+e.limit_id,name:"remarks-"+e.limit_id,hidden:!0,value:e.remarks},{view:"text",id:"remarksBtn-"+e.limit_id,width:95,inputAlign:"center",readonly:!0,css:e.remarks?"with_remarks":"remarks",value:__("Remarks")+" ▶",tooltip:__("Click to add specific remarks for boundary Nr.")+": "+e.limit_id,limitId:e.limit_id,click:function(){ApprovalCtrl.showRemarksArea(this)}}]})}),webix.ui(a,$$("isf:concepts_layout"),$$("isf:concepts_form")),t.signature?(this.signaturePad.fromData(JSON.parse(t.signature)),document.getElementById("signature_image").src=this.signaturePad.toDataURL()):document.getElementById("signature_image").src="images/no-signature.png",t.fingerprint?document.getElementById("fingerprint_image").src="data:image/png;base64,"+t.fingerprint:document.getElementById("fingerprint_image").src="images/no-fingerprint.png",t.details?(webix.html.addCss($$("isf:comments_btn").getNode(),"with_remarks"),$$("isf:general_remarks").setValue(t.details)):(webix.html.addCss($$("isf:comments_btn").getNode(),"remarks"),$$("isf:general_remarks").setValue()),$$("isf:comments_window").getHead().getChildViews()[0].setHTML("&nbsp;"+__("Comments or Observations on Parcel")+":&nbsp;"+ApprovalCtrl.spatialunitData.details.id)},showRemarksArea:function(a){webix.ui({view:"window",id:"apv:remarks_window",modal:!0,animate:{direction:"bottom"},height:150,width:300,head:{cols:[{view:"label",css:{"font-weight":"bold"},label:"&nbsp;"+__("Remarks for Boundary Nr.")+":&nbsp;"+a.config.limitId},{view:"button",width:40,label:"◀",icon:"fas fa-caret-left",click:function(){var e,t;$$("remarks-"+a.config.limitId).setValue($$("apv:remarks_area").getValue()),t=""==$$("apv:remarks_area").getValue()?(e="remarks","with_remarks"):(e="with_remarks","remarks"),webix.html.removeCss($$("remarksBtn-"+a.config.limitId).getNode(),t),webix.html.addCss($$("remarksBtn-"+a.config.limitId).getNode(),e),$$("apv:remarks_window").close()}}]},body:{view:"textarea",id:"apv:remarks_area",placeholder:__("Type in remarks for this boundary..."),value:$$("remarks-"+a.config.limitId).getValue(),on:{onChange:function(){$$("apv:signatures_cnt").modified||(webix.html.addCss($$("isf:signature-form-header").getNode(),"modified-value-"+appdata.lang),$$("apv:signatures_cnt").modified=!0,$$("isf:save_btn").enable())}}}}).show(a.getNode(),{pos:"top",x:2,y:-2})},showSignWindow:function(){ApprovalCtrl.currSignatureData=new Array,ApprovalCtrl.signaturePad.toData().forEach(function(e){ApprovalCtrl.currSignatureData.push(e)}),$$("signature_window").getHead().getChildViews()[0].setHTML("&nbsp;"+__("Signature Pad for")+" &rarr; "+$$("apv:signatures_cnt").config.record.full_name),ApprovalCtrl.signatureWindow.show()},onSignatureWindowButtonClick:function(e){"sgw:clear_btn"==e?ApprovalCtrl.signaturePad.clear():"sgw:save_btn"==e?ApprovalCtrl.signaturePad.isEmpty()?webix.message({expire:2e3,text:__("No signature detected!!!")}):($$("isf:carousel").setActiveIndex(0),document.getElementById("signature_image").src=ApprovalCtrl.signaturePad.toDataURL(),ApprovalCtrl.signatureWindow.hide(),$$("apv:signatures_cnt").modified||(webix.html.addCss($$("isf:signature-form-header").getNode(),"modified-value-"+appdata.lang),$$("apv:signatures_cnt").modified=!0,$$("isf:save_btn").enable())):(ApprovalCtrl.signaturePad.fromData(ApprovalCtrl.currSignatureData),ApprovalCtrl.signatureWindow.hide())},showFingerprintWindow:()=>{ApprovalCtrl.fingerprintObject.getInfo().then(function(e){0==e.length?webix.message({expire:2e3,text:__("There is no fingerprint reader connected!!!")}):($$("fingerprint_window").getHead().getChildViews()[0].setHTML("&nbsp;"+__("Fingerprint Pad for")+" &rarr; "+$$("apv:signatures_cnt").config.record.full_name),$$("fingerprint_window").show(),(e=document.createElement("img")).id="fgp_image",e.src=document.getElementById("fingerprint_image").src,document.getElementById("fingerprint_div").appendChild(e),ApprovalCtrl.fingerprintObject.startScan())})},fgpSampleAcquired:e=>{ApprovalCtrl.fingerprintSample=JSON.parse(e.samples)[0];var t=document.getElementById("fingerprint_div");t.innerHTML="";e=document.createElement("img");e.id="fgp_image",e.src="data:image/png;base64,"+Fingerprint.b64UrlTo64(ApprovalCtrl.fingerprintSample),t.appendChild(e),$$("fpw:save_btn").enable()},onFingerprintWindowButtonClick:e=>{"fpw:clear_btn"==e?(document.getElementById("fingerprint_div").innerHTML="",$$("fpw:save_btn").disable()):"fpw:save_btn"==e?($$("isf:carousel").setActiveIndex(1),document.getElementById("fingerprint_image").src=document.getElementById("fingerprint_div").firstChild.src,ApprovalCtrl.fingerprintObject.stopScan(),$$("fingerprint_window").hide(),document.getElementById("fingerprint_div").innerHTML="",$$("apv:signatures_cnt").modified||(webix.html.addCss($$("isf:signature-form-header").getNode(),"modified-value-"+appdata.lang),$$("apv:signatures_cnt").modified=!0,$$("isf:save_btn").enable())):(ApprovalCtrl.fingerprintObject.stopScan(),$$("fpw:save_btn").disable(),document.getElementById("fingerprint_div").innerHTML="",$$("fingerprint_window").hide())},onSignFormCancel:()=>{$$("apv:signatures_cnt").modified?webix.confirm({title:"Warning",ok:__("Yes"),cancel:__("No"),text:__("There are unsaved changes. Are you sure you want to cancel?")}).then(function(){$$("apv:signatures_cnt").modified=!1,$$("isf:save_btn").disable(),webix.html.removeCss($$("isf:signature-form-header").getNode(),"modified-value-"+appdata.lang),$$("apv:approval_forms").setValue("apv:partgrid_cnt"),$$("apv:party_grid").clearSelection(),$$("apv:signatures_cnt").config.record=null,ApprovalCtrl.signaturePartyId=null,$$("nav:sidebar").enable(),webix.html.removeCss($$("isf:comments_btn").getNode(),"remarks"),webix.html.removeCss($$("isf:comments_btn").getNode(),"with_remarks")}):($$("apv:approval_forms").setValue("apv:partgrid_cnt"),$$("apv:party_grid").clearSelection(),$$("apv:signatures_cnt").config.record=null,ApprovalCtrl.signaturePartyId=null,ApprovalCtrl.signaturePad.clear(),webix.html.removeCss($$("isf:comments_btn").getNode(),"remarks"),webix.html.removeCss($$("isf:comments_btn").getNode(),"with_remarks"),$$("nav:sidebar").enable())},onSignFormSave:()=>{var d,c=new Object;c.signature=ApprovalCtrl.signaturePad.isEmpty()?null:JSON.stringify(ApprovalCtrl.signaturePad.toData()),c.fingerprint=ApprovalCtrl.fingerprintSample?Fingerprint.b64UrlTo64(ApprovalCtrl.fingerprintSample):null,c.signature||c.fingerprint?(webix.html.removeCss($$("isf:signature-form-header").getNode(),"modified-value-"+appdata.lang),c.su_id=ApprovalCtrl.spatialunitData.details.id,c.party_id=ApprovalCtrl.signaturePartyId,c.details=$$("isf:general_remarks").getValue(),d=ApprovalCtrl.spatialunitData.parties.find(function(e){return e.objectid==ApprovalCtrl.signaturePartyId}),c.right_id=d.right_id,c.concepts=$$("isf:concepts_form").getValues(),webix.ajax().post("api/concepts/update/",{...appdata.dbparams,...c}).then(function(e){if(e.json().success){webix.ajax().get("api/tools/refreshviews/",appdata.dbparams).then(function(e){var t;e.json().success?(MapCtrl.conceptsLayer.getSource().refresh(),(t=$$("overview-cnt").config.getController()).conceptsLayer&&(t.conceptsLayer.getSource().refresh(),t.spatialunitConceptsLayer.getSource().refresh()),appdata.timeline||(appdata.timeline=!0,$$("ovw:timeline_checkbox").show()),$$("dashboard-cnt").config.getController().refreshView=!0,$$("overview-cnt").config.getController().refreshView=!0):showErrorMsg(null,"Failed to refresh materialized views<br />---<br />"+e.json().message)},e=>{showErrorMsg(e,"")}),d.details=c.details,d.signature=c.signature,d.fingerprint=c.fingerprint,d.signed_on=dateFormat_dMY(new Date);var t,a,r,i,n,o,l=Object.entries($$("isf:concepts_form").getDirtyValues()),s=ApprovalCtrl.spatialunitData.concepts;for([n,o]of l){i=r=a=null,-1!=n.indexOf("status")&&(a="true"==o.toLowerCase(),t=n.replace("status-","")),-1!=n.indexOf("sign_date")&&(r=o,t=n.replace("sign_date-","")),-1!=n.indexOf("remarks")&&(i=o,t=n.replace("remarks-",""));for(const p of s)p.limit_id==t&&(null!=a&&(p.status=a),r&&(p.sign_date=dateFormat_dMY(new Date)),i&&(p.remarks=i))}$$("apv:signatures_cnt").modified=!1,$$("isf:save_btn").disable(),webix.alert({title:"Success",text:__("The changes have been saved..."),ok:"Continue"}).then(()=>{$$("apv:signatures_cnt").modified=!1,$$("isf:save_btn").disable(),$$("isf:concepts_form").setDirty(!1),webix.html.removeCss($$("isf:signature-form-header").getNode(),"modified-value-"+appdata.lang),$$("apv:approval_forms").setValue("apv:partgrid_cnt"),$$("apv:party_grid").clearSelection()})}else showErrorMsg(null,e.json().message),$$("partyform_cnt").config.getController().onSuggestHide()},e=>{showErrorMsg(e,"")}),$$("nav:sidebar").enable()):webix.alert({title:__("Warning"),text:__("Please provide a signature and/or a fingerprint")})}};ApprovalCtrl.fingerprintObject=new FingerprintReader(ApprovalCtrl.fgpSampleAcquired);export{ApprovalCtrl};