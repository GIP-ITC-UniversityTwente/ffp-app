import{mapStyle}from"../../common/mapstyles";import{AddSwitcherControl}from"../shared/layerswitcher";import{ApprovalCtrl}from"./ApprovalController";var MapCtrl={navMap:null,mosaicLayer:null,spatialunitsLayer:null,neighboursLayer:null,approvalLayer:null,conceptsLayer:null,vertexpointsLayer:null,anchorpointsLayer:null,surveypointsLayer:null,selectionInteraction:null,rmsInteraction:null,selectionCount:0,initMap:function(e){this.navMap=e,this.mosaicLayer=new ol.layer.Image({source:new ol.source.ImageWMS,title:"Mosaic",name:"mosaic",switcher:!0,visible:!0}),this.navMap.addLayer(this.mosaicLayer),this.spatialunitsLayer=new ol.layer.Vector({source:new ol.source.Vector({format:new ol.format.GeoJSON}),title:"Spatialunits",name:"spatialunits",switcher:!1,style:mapStyle.spatialunitWithLabel("label")}),this.navMap.addLayer(this.spatialunitsLayer),this.neighboursLayer=new ol.layer.Vector({source:new ol.source.Vector,title:"Neighbours",name:"neighbours",switcher:!1,style:mapStyle.neighbourWithId()}),this.navMap.addLayer(this.neighboursLayer),this.approvalLayer=new ol.layer.Vector({source:new ol.source.Vector,title:"Approval Status",name:"approval",switcher:!1,style:mapStyle.selectedSpatialunitWithLabel("label")}),this.navMap.addLayer(this.approvalLayer),this.conceptsLayer=new ol.layer.Vector({source:new ol.source.Vector,title:"Concepts",name:"boundary_concepts",switcher:!0,style:mapStyle.spatialunitConcepts()}),this.navMap.addLayer(this.conceptsLayer),this.vertexpointsLayer=new ol.layer.Vector({source:new ol.source.Vector,title:"Vertex Points",name:"vertexpoints",switcher:!0,style:mapStyle.vertexpoints()}),this.vertexpointsLayer.setVisible(!1),this.navMap.addLayer(this.vertexpointsLayer),this.anchorpointsLayer=new ol.layer.Vector({source:new ol.source.Vector,title:"Anchor Points",name:"anchorpoints",switcher:!0,style:mapStyle.anchorpoints()}),this.navMap.addLayer(this.anchorpointsLayer),this.surveypointsLayer=new ol.layer.Vector({source:new ol.source.Vector,title:"Surveyed Points",name:"surveypoints",switcher:!0,style:mapStyle.surveypoints()}),this.surveypointsLayer.setVisible(!1),this.navMap.addLayer(this.surveypointsLayer),this.selectionInteraction=new ol.interaction.Select({layers:[this.spatialunitsLayer],condition:ol.events.condition.click,style:mapStyle.selectedSpatialunitWithLabel("label")}),this.navMap.addInteraction(this.selectionInteraction),this.rmsInteraction=new ol.interaction.Select({layers:[this.surveypointsLayer],condition:ol.events.condition.click,style:mapStyle.surveypointsWithRms()}),this.navMap.addInteraction(this.rmsInteraction),this.rmsInteraction.setActive(!1),this.selectionInteraction.getFeatures().on("add",function(e){MapCtrl.selectionCount++}),this.selectionInteraction.getFeatures().on("remove",function(e){MapCtrl.selectionCount--}),AddSwitcherControl(this.navMap,"apv"),$$("apv:layer_switcher").disable(),appdata.mosaic&&(this.mosaicLayer.setSource(new ol.source.ImageWMS({url:appdata.wmsUrl,params:{LAYERS:"mosaic",TILED:!0,MOSAIC:"mosaic_"+appdata.dbparams.database.toLowerCase()}})),this.mosaicLayer.setVisible(!0))},retrieveSpatialUnits:a=>{ApprovalCtrl.switchBasemap&&(MapCtrl.navMap.setBasemap(appdata.basemap),ApprovalCtrl.switchBasemap=!1);var e={id_number:a.id_number};webix.ajax().get("api/spatialunit/party/",{...appdata.dbparams,...e}).then(e=>{var t;e.json().success?((t=(new ol.format.GeoJSON).readFeatures(e.json().collection)).forEach(function(e){ApprovalCtrl.idList.push(e.get("id"))}),MapCtrl.spatialunitsLayer.getSource().clear(),MapCtrl.spatialunitsLayer.getSource().addFeatures(t),t=MapCtrl.spatialunitsLayer.getSource().getExtent(),MapCtrl.navMap.getView().setCenter(ol.extent.getCenter(t)),MapCtrl.navMap.getView().fit(t,MapCtrl.navMap.getSize()),MapCtrl.navMap.getView().setZoom(MapCtrl.navMap.getView().getZoom()-.5),$$("apv:map_party_name").setValue(a.first_name+" "+a.last_name)):showErrorMsg(null,e.json().message)},e=>{showErrorMsg(e,"")})},setConceptStyle:function(t,a){this.conceptsLayer.getSource().getFeatures().forEach(function(e){e.getProperties().ogc_id==t&&e.setStyle(a)})}};export{MapCtrl};