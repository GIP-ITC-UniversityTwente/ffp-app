import{imageBasemaps}from"../../common/basemaps";import{mapStyle}from"../../common/mapstyles";import{showErrorMsg}from"../../common/tools";var SettingsCtrl={loadSrid:!0,validateSrid:!1,initConnectionForm:()=>{let a=$$("app:dbform");var e=appdata.dbparams;a.setValues({"dbconn:server":e.host,"dbconn:port":e.port,"dbconn:user":e.user,"dbconn:schema":e.schema,"dbconn:database":e.database})},toggleLanguage:a=>{a!=appdata.lang&&(localStorage.setItem("appLang",a),appdata.dbparams.database&&localStorage.setItem("appDatabase",appdata.dbparams.database),location.reload())},setBasemap:a=>{appdata.basemap=a,appdata.imageBasemap=!!imageBasemaps.includes(a);var e=$$("overview-cnt").config.getController();e.navMap?(e.navMap.setBasemap(a),e.spatialunitsLayer.setStyle(mapStyle.spatialunitWithLabel("ogc_id",!1))):e.switchBasemap=!0,(e=$$("approval-cnt").config.getController().mapCtrl).navMap?(e.navMap.setBasemap(a),e.spatialunitsLayer.setStyle(mapStyle.spatialunitWithLabel("label")),e.approvalLayer.setStyle(mapStyle.selectedSpatialunitWithLabel("label"))):e.switchBasemap=!0,(e=$$("inquieries-cnt").config.getController()).navMap?(e.navMap.setBasemap(a),e.spatialunitLayer.setStyle(mapStyle.spatialunitWithLabel(null))):e.switchBasemap=!0},checkConnection:a=>{a?$$("app:dbform").validate()?(appdata.dbparams.database=$$("app:dbform").getValues()["dbconn:database"],webix.ajax().get("api/tools/checkconnection/",appdata.dbparams).then(function(a){a.json().success?SettingsCtrl.onConnectionSuccess(a.json()):(SettingsCtrl.onConnectionError(),showErrorMsg(null,a.json().message))},a=>{SettingsCtrl.onConnectionError(),showErrorMsg(a,"")})):($$("app:connect").toggle(),webix.message({type:"error",expire:2e3,text:__("Database field cannot be empty")})):webix.confirm({title:"Warning",ok:__("Yes"),cancel:__("No"),text:__("This action will reset the application.<br />Are you sure<br />you want to disconnect?")}).then(()=>{$$("app:srid_form").disable(),$$("nav:sidebar").disable(),$$("app:dbform").enable()}).fail(()=>{$$("app:connect").setValue(1)})},onConnectionError:()=>{$$("app:connect").toggle(),console.log("prevented")},onConnectionSuccess:a=>{webix.message({type:"info",text:__("Succesfully connected to")+" "+appdata.dbparams.database,expire:1e3}),appdata.mosaic=a.mosaic,appdata.timeline=0<a.timeline.count,appdata.querystring=Object.keys(appdata.dbparams).map(a=>a+"="+appdata.dbparams[a]).join("&"),appdata.basedata=a.basedata;var e="map="+appdata.path+"\\ows.map",a="http://"+window.location.hostname+"/cgi-bin/mapserv.exe?";appdata.wmsUrl=a+e+"&"+appdata.querystring,appdata.wfsUrl=appdata.wmsUrl+"&service=WFS&version=1.1.0&request=GetFeature&outputFormat=geojson&srsname=EPSG:3857",$$("app:srid_list").getList().config.dataFeed="api/tools/sridlist/?"+appdata.querystring,$$("pf:search_list").getList().config.dataFeed="api/party/search/?"+appdata.querystring,$$("crt:search_list").getList().config.dataFeed="api/spatialunit/search/?"+appdata.querystring,$$("inq:search_list").getList().config.dataFeed="api/inquieries/search/?"+appdata.querystring,SettingsCtrl.loadSrid&&($$("nav:container").setValue("approval-cnt"),$$("nav:container").setValue("settings-cnt")),$$("approval-cnt").config.getController().resetInspectionForms(),SettingsCtrl.loadSrid&&SettingsCtrl.setCurrentSrid(),$$("app:srid_form").enable(),$$("nav:sidebar").enable(),$$("app:dbform").disable(),$$("overview-cnt").config.getController().refreshView=!0,$$("dashboard-cnt").config.getController().refreshView=!0,$$("approval-cnt").config.getController().mapCtrl.navMap&&($$("approval-cnt").config.getController().refreshView=!0),$$("inquieries-cnt").config.getController().refreshView=!0,appdata.basedata.roads?$$("crt:roads").enable():$$("crt:roads").disable(),appdata.basedata.tiles100k?$$("crt:tiles100k").enable():$$("crt:tiles100k").disable(),$$("certificates-cnt").config.getController().navMap&&$$("certificates-cnt").config.getController().resetFields()},setCurrentSrid:()=>{$$("app:srid_list").getList().load("api/tools/sridlist/?filter[value]="+appdata.srid+"&"+appdata.querystring).then(()=>{$$("app:srid").setValue(appdata.srid),$$("app:srtext").setValue($$("app:srid_list").getList().getItem(appdata.srid).displaytext),SettingsCtrl.loadSrid=!1})},onValidateSrid:()=>{let t=$$("app:srid").getValue();if(t!=appdata.srid){let a=!1;if(""==t)a=!0,webix.message({type:"error",text:__("An SRID number is required")});else if(0==$$("app:srid_list").getList().getVisibleCount())webix.message({type:"error",text:t+" "+__("is not a valid SRID number")}),a=!0;else{let e=new Array;for(let a=0;a<$$("app:srid_list").getList().getVisibleCount();a++)e.push($$("app:srid_list").getList().getItem($$("app:srid_list").getList().getIdByIndex(a)).srid);e.find(a=>a==t)||(webix.message({type:"error",text:t+" "+__("is not a valid SRID number")}),a=!0)}a?(SettingsCtrl.loadSrid=!0,SettingsCtrl.setCurrentSrid()):(SettingsCtrl.validateSrid=!1,SettingsCtrl.onSridSelect(t))}},onSridSelect:e=>{if(appdata.srid!=e){appdata.srid=e,$$("app:srtext").setValue($$("app:srid_list").getList().getItem(appdata.srid).displaytext),$$("dashboard-cnt").config.getController().sridChanged=!0,$$("approval-cnt").config.getController().sridChanged=!0,$$("inq:container").setValue("inq:list");let a=$$("overview-cnt").config.getController();a.selectInteraction&&1==a.selectInteraction.getFeatures().getArray().length&&(a.onFeatureSelected(a.selectInteraction.getFeatures().getArray()[0]),$$("overview-cnt").config.getController().sridChanged=!0),appdata.sridTooltip=__("Value calculated using")+' SRID: <span class="srid">'+appdata.srid+"</span>"}}};export{SettingsCtrl};