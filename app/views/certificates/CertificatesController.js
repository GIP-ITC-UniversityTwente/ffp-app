import{mapStyle}from"../../common/mapstyles";import{dateFormat_dMY,showErrorMsg}from"../../common/tools";import{disclaimer,gratciculeIntervals}from"../../models/config";var CertificatesCtrl={navMap:null,cartoLayer:null,graticuleLayer:null,neighboursLayer:null,roadsLayer:null,spatialunitLayer:null,applyDeclutter:!0,needsCentering:!1,signaturePad:null,obsValue:null,surveyorValue:null,surveyDate:null,disclaimerTxt:disclaimer,userEvent:!0,neighLabel:!1,neighName:!0,neighboursData:!0,initMap:function(){this.navMap=$$("crt:navmap").navMap,this.navMap.getLayers().getArray()[0].setVisible(!1),this.navMap.getControls().getArray()[0].element.style.display="none",this.navMap.getControls().getArray()[1].element.getElementsByClassName("ol-compass")[0].innerHTML="â†‘",this.navMap.getControls().getArray()[1].autoHide_=!1;{let e=ol.proj.get("EPSG:3857");var r=e.getExtent(),i=ol.extent.getWidth(r)/256;let t=new Array(18),a=new Array(18);for(var s=0;s<18;++s)t[s]=i/Math.pow(2,s),a[s]=s;this.cartoLayer=new ol.layer.Tile({source:new ol.source.WMTS({url:"https://gw-geoportal-test.igac.gov.co/cartografia100k/service",layer:"cartografia_100k",matrixSet:"gmwm",format:"image/png",projection:e,tileGrid:new ol.tilegrid.WMTS({origin:ol.extent.getTopLeft(r),resolutions:t,matrixIds:a}),style:"default"}),minZoom:10,title:"Carto 100K",name:"carto100K",switcher:!1,visible:!1}),this.navMap.getControls().getArray()[2].setCollapsed(!1),this.navMap.getControls().getArray()[2].setCollapsible(!1),this.navMap.getLayers().getArray()[0].getSource().setAttributions('Basemap Tiles &copy; <a href="#">IGAC</a>.')}this.graticuleLayer=new ol.layer.Graticule({strokeStyle:new ol.style.Stroke({color:"rgba(180, 180, 180, 0.9)",width:1}),showLabels:!0,lonLabelPosition:0,intervals:gratciculeIntervals,wrapX:!1}),this.neighboursLayer=new ol.layer.Vector({source:new ol.source.Vector,name:"neighbours",declutter:this.applyDeclutter}),this.roadsLayer=new ol.layer.Image({source:new ol.source.ImageWMS({url:appdata.wmsUrl,params:{LAYERS:"roads",TILED:!0}}),minZoom:12,title:"Roads",name:"roads",switcher:!1,visible:!1}),this.spatialunitLayer=new ol.layer.Vector({source:new ol.source.Vector,name:"spatialunit",style:mapStyle.crt_spatialunit()}),this.navMap.getLayers().extend([this.cartoLayer,this.graticuleLayer,this.roadsLayer,this.neighboursLayer,this.spatialunitLayer]),this.spatialunitLayer.getSource().on("change",function(){let e=CertificatesCtrl;var t,a;0<e.spatialunitLayer.getSource().getFeatures().length&&(t=e.spatialunitLayer.getSource().getExtent(),a=e.neighboursLayer.getSource().getExtent(),a=[Math.min(t[0],a[0]),Math.min(t[1],a[1]),Math.max(t[2],a[2]),Math.max(t[3],a[3])],e.navMap.getView().setCenter(ol.extent.getCenter(a)),e.navMap.getView().fit(a,e.navMap.getSize()),e.navMap.getView().setZoom(e.navMap.getView().getZoom()-.2))}),this.navMap.getView().setMaxZoom(19)},onFieldEdit:(e,t)=>{"crt:municipality"!=e.config.id&&"crt:village"!=e.config.id||$$(e.config.id+"_txt").setValue(t),"crt:surveyor"==e.config.id&&(CertificatesCtrl.surveyorValue=t,$$("crt:page_1").queryView({field:"crt:surveyor_txt"}).refresh(),$$("crt:page_2").queryView({field:"crt:surveyor_txt"}).refresh()),"crt:obs"==e.config.id&&(CertificatesCtrl.obsValue=t,$$("crt:page_1").queryView({field:"crt:obs_txt"}).refresh(),$$("crt:page_2").queryView({field:"crt:obs_txt"}).refresh()),"crt:disclaimer"==e.config.id&&(CertificatesCtrl.disclaimerTxt=t,$$("crt:disclaimer_txt$1").refresh(),$$("crt:disclaimer_txt$2").refresh())},resetFields:()=>{var e=[{template:"&nbsp;"}];webix.ui(e,$$("crt:signatures$1")),webix.ui(e,$$("crt:signatures$2")),$$("crt:page_2").hide(),$$("crt:details_right").clear(),$$("crt:details_left").clear(),CertificatesCtrl.surveyDate=null,$$("crt:page_1").queryView({field:"crt:surveyor_txt"}).refresh(),$$("crt:page_2").queryView({field:"crt:surveyor_txt"}).refresh(),$$("crt:party").getList()&&$$("crt:party").getList().clearAll(),$$("crt:party").setValue(null),$$("crt:search_list").getList().clearAll(),$$("crt:search").setValue(null),$$("crt:municipality").setValue(null),$$("crt:village").setValue(null),$$("crt:obs").setValue(null),CertificatesCtrl.spatialunitLayer.getSource().clear(),CertificatesCtrl.neighboursLayer.getSource().clear(),CertificatesCtrl.navMap.getView().setCenter([0,0]),CertificatesCtrl.navMap.getView().setZoom(2),CertificatesCtrl.navMap.getView().setRotation(0),$$("crt:search").enable(),$$("crt:reset").disable(),$$("crt:print").disable(),$$("crt:map_toggle").disable(),$$("crt:params_form$2").clearValidation(),$$("crt:map_toggle").setValue(0)},switchGraticle:e=>{let t=CertificatesCtrl.navMap.getControls().getArray();0==e?(t[1].element.classList.remove("ol-hidden"),CertificatesCtrl.graticuleLayer.setVisible(!1)):(t[1].element.classList.add("ol-hidden"),CertificatesCtrl.graticuleLayer.setVisible(!0))},getGeometries:(t,e)=>{let a=CertificatesCtrl,r=e.map(e=>e.su_id);0==r.length&&(r=[0]);var i=`${appdata.wfsUrl}&typename=ffp:neighbours&SUIDS=${r}`;a.neighboursData=e,a.neighboursLayer.setStyle(mapStyle.crt_neighbours(a.neighName,a.neighLabel,e)),webix.ajax().get(i).then(function(e){e=(new ol.format.GeoJSON).readFeatures(e.json());a.neighboursLayer.getSource().addFeatures(e),i=`${appdata.wfsUrl}&typename=ffp:crt_spatialunit&SU_ID=${t.spatialunit_id}`,webix.ajax().get(i).then(function(e){e=(new ol.format.GeoJSON).readFeatures(e.json());a.spatialunitLayer.getSource().addFeatures(e)})})},retrieveData:t=>{var e={su_id:t.spatialunit_id,srid:appdata.srid,getlocation:appdata.basedata.villages};webix.ajax().get("api/certificate/",{...appdata.dbparams,...e}).then(function(e){e.json().success?CertificatesCtrl.populateCertificate(t,e.json()):showErrorMsg(null,e.json().message)},e=>{showErrorMsg(e,"")})},populateCertificate:(t,e)=>{CertificatesCtrl.getGeometries(t,e.status);var a,r=e.parties.find(e=>e.party_id==t.party_id),i=new Array;for(a of e.parties)i.push({id:a.id_number,value:a.full_name});$$("crt:party").define("options",i),$$("crt:party").refresh(),CertificatesCtrl.userEvent=!1,$$("crt:party").setValue(t.id_number);var s=e.location.municipality_name;s&&$$("crt:municipality").setValue(s),$$("crt:details_left").setValues({"crt:municipality_txt":s,"crt:fullname_txt":r.full_name,"crt:sulabel_txt":e.details.su_label,"crt:legalid_txt":e.details.legal_id});s=e.location.village_name;s&&$$("crt:village").setValue(s),$$("crt:details_right").setValues({"crt:village_txt":s,"crt:idnumber_txt":r.id_number||"","crt:physicalid_txt":e.details.physical_id}),e.details.gps_bearer&&$$("crt:obs").setValue('El contacto de la visita fue "'+e.details.gps_bearer+'"'),CertificatesCtrl.surveyDate=dateFormat_dMY(e.details.surveyed_on),$$("crt:page_1").queryView({field:"crt:surveyor_txt"}).refresh(),$$("crt:page_2").queryView({field:"crt:surveyor_txt"}).refresh(),$$("crt:page_3").show();var l,n,o=document.getElementById("crt_signature_canvas");CertificatesCtrl.signaturePad=new SignaturePad(o,{}),CertificatesCtrl.signaturePad.off(),$$("crt:page_3").hide();let c=0,u=new Array,p=new Array;for(n of e.status)for(var g of n.status_list)c+=1,CertificatesCtrl.signaturePad.clear(),l=g.signature&&g.status?(CertificatesCtrl.signaturePad.fromData(JSON.parse(g.signature)),cropSignatureCanvas(o)):"images/blank.png",l={type:"clean",cols:[{width:340,template:`<div><b>${c}- Nombre:</b>&nbsp;&nbsp;<span class="crt_value">${g.full_name}</span></div>
                        <div style="padding-left:15px; padding-top:4px;"><span><b>Predio:</b></span>&nbsp;&nbsp;<span class="crt_value">${n.spatialunit_name}</span></div>`},{width:150,template:`<b>C.C.:</b>&nbsp;&nbsp;<span class="crt_value">${g.id_number||""}</span>`},{width:48,template:'<div style="padding-top:15px;"><b>Firma:</b></div>'},{template:`<div class="crt_signature"><img src="${l}" /></div>`}]},6!=c&&(l.height=45),(c<=6?u:p).push(l);c<=6&&u.push({template:"&nbsp;"}),webix.ui(u,$$("crt:signatures$1")),6<c&&($$("crt:page_2").show(),p.push({template:"&nbsp;"}),webix.ui(p,$$("crt:signatures$2"))),$$("crt:search").disable(),$$("crt:reset").enable(),$$("crt:print").enable(),$$("crt:map_toggle").enable()},print:()=>{$$("crt:params_form$2").validate()&&($$("crt:page_2").isVisible()?($$("crt:page_3").show(),webix.print($$("crt:pages"),{paper:"letter",margin:0}),$$("crt:page_3").hide()):webix.print($$("crt:page_1"),{paper:"letter",margin:0}))}};export{CertificatesCtrl};