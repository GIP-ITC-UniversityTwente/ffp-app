import{Codelist}from"../../common/codelists";import{attachmentTemplate,attachmentTemplateExt,dateFormat_dMY,showErrorMsg}from"../../common/tools";import{mapStyle}from"../../common/mapstyles";var InquieriesCtrl={navMap:null,mapRendered:!1,mosaicLayer:null,spatialunitLayer:null,neighboursLayer:null,refreshView:!0,switchBasemap:!1,createPartyElement:(e,t)=>{let a=new Array;if(0<t.length)for(var i of t)a.push({width:500,borderless:!0,css:"party_attachment_cnt",data:{type:"",class:"party",src:"api/attachment/?"+appdata.querystring+"&att_class=party&global_id="+i.image_id,alt:i.image_id},template:attachmentTemplate,css:"party_attachment_cnt"});return{rows:[{height:12,borderless:!0},{view:"template",type:"header",css:{background:"aliceblue"},template:e.full_name},{cols:[{width:200,view:"form",elementsConfig:{labelPosition:"top",readonly:!0},elements:[{view:"text",label:__("ID Number")+":",format:"1,111",value:e.id_number},{view:"text",label:__("Date of Birth")+":",value:dateFormat_dMY(e.date_of_birth)},{view:"text",label:__("Civil Status")+":",value:Codelist("civilstatus",e.civil_status)},{view:"text",label:__("Telephone Number")+":",value:0!=e.phone_number?e.phone_number:""},{view:"text",label:__("Housing Subsidy")+":",value:1==e.housing_subsidy?__("Yes"):__("No")},{view:"text",label:__("Owns Other Properties")+":",value:1==e.other_ownership_rights?__("Yes"):__("No")}]},{view:"scrollview",scroll:"x",body:{type:"form",cols:a}}]},{height:12,borderless:!0}]}},onRecordsLoad:e=>{e={id_list:$$("inq:search_list").getList().getItem(e).oids.toString()};webix.ajax().get("api/inquieries/list/",{...appdata.dbparams,...e}).then(function(e){var t;e.json().success?(t=e.json().spatialunits,$$("inq:su_grid").parse(t)):(SettingsCtrl.onConnectionError(),showErrorMsg(null,e.json().message))},e=>{showErrorMsg(e,"")})},initMap:function(e){this.navMap=e,this.mosaicLayer=new ol.layer.Tile({source:new ol.source.TileWMS,title:"Mosaic",name:"mosaic",switcher:!0,visible:!1}),this.navMap.addLayer(this.mosaicLayer),this.neighboursLayer=new ol.layer.Vector({source:new ol.source.Vector,title:"Neighbours",name:"neighbours",switcher:!1,style:mapStyle.neighbourWithId()}),this.navMap.addLayer(this.neighboursLayer),this.spatialunitLayer=new ol.layer.Vector({source:new ol.source.Vector,title:"Spatialunits",name:"spatialunits",switcher:!1,style:mapStyle.spatialunitWithLabel(null)}),this.navMap.addLayer(this.spatialunitLayer),this.hoverInteraction=new ol.interaction.Select({layers:[this.spatialunitLayer,this.neighboursLayer],condition:ol.events.condition.pointerMove,style:mapStyle.inquieriesHover(!1)}),this.navMap.addInteraction(this.hoverInteraction),webix.event("inq:navmap_div","mouseout",()=>{InquieriesCtrl.hoverInteraction.getFeatures().clear()}),appdata.mosaic&&(this.mosaicLayer.setSource(new ol.source.TileWMS({url:appdata.wmsUrl,params:{LAYERS:"mosaic",TILED:!0,MOSAIC:"mosaic_"+appdata.dbparams.database.toLowerCase()}})),this.mosaicLayer.setVisible(!0)),this.mapRendered=!0},onViewShow:function(){this.switchBasemap&&($$("inq:navmap").navMap.setBasemap(appdata.basemap),this.switchBasemap=!1),this.refreshView&&(this.mapRendered&&(this.spatialunitLayer.getSource().clear(),this.neighboursLayer.getSource().clear(),this.hoverInteraction.getFeatures().clear()),$$("inq:su_grid").clearAll(),$$("inq:search").setValue(null),$$("inq:search_list").getList().clearAll(),$$("inq:container").setValue("inq:list"),this.refreshView=!1)},showReport:function(e){let o={objectid:$$("inq:su_grid").getItem(e).objectid,srid:appdata.srid};webix.ajax().get("api/inquieries/report/",{...appdata.dbparams,...o}).then(function(i){if(i.json().success){$$("inq:container").setValue("inq:report"),InquieriesCtrl.mapRendered||InquieriesCtrl.initMap($$("inq:navmap").navMap);let e=i.json();webix.ui([],$$("inq:party_cnt"));for(let a of e.parties){let t=new Array;e.party_attachments.forEach(e=>{e.id_number==a.id_number&&t.push(e)}),$$("inq:party_cnt").addView(InquieriesCtrl.createPartyElement(a,t))}var r,s=new Array,n=new Array;for(r of e.right_attachments)s.push({id:r.image_id,alt:r.image_id,src:"api/attachment/?"+appdata.querystring+"&att_class=right&global_id="+r.image_id}),n.push({id:r.image_id,data:{class:"right",alt:r.image_id,src:"api/attachment/?"+appdata.querystring+"&att_class=right&global_id="+r.image_id},template:attachmentTemplateExt});0<s.length&&($$("inq:rightAtt_idx").clearAll(),$$("inq:rightAtt_idx").parse(s),$$("inq:rightAtt_idx").select(s[0].id),webix.ui(n,$$("inq:rightAtt_carrousel")));let t=e.su_details,a=(new ol.format.GeoJSON).readFeature(t.geometry);a.setProperties({ogc_id:o.objectid.toString(),physical_id:t.physical_id}),InquieriesCtrl.spatialunitLayer.getSource().clear(),InquieriesCtrl.spatialunitLayer.getSource().addFeature(a);var l=InquieriesCtrl.spatialunitLayer.getSource().getExtent();InquieriesCtrl.navMap.getView().setCenter(ol.extent.getCenter(l)),InquieriesCtrl.navMap.getView().fit(l,InquieriesCtrl.navMap.getSize()),InquieriesCtrl.navMap.getView().setZoom(InquieriesCtrl.navMap.getView().getZoom()-1),InquieriesCtrl.neighboursLayer.setSource(new ol.source.Vector({format:new ol.format.GeoJSON,url:appdata.wfsUrl+"&typename=ffp:neighbours&SUIDS="+e.neighbours.list}));l=Number(t.area_m2)<9e3?t.area_m2+" mÂ²":(Number(t.area_m2)/1e4).toFixed(1)+" has";$$("inq:details_form").setValues({"inq:details_physicalid":t.physical_id?t.physical_id.join(", "):"","inq:details_label":null==t.address?__("---"):t.address,"inq:details_spatialunittype":t.spatialunit_type,"inq:details_area":l,"inq:details_legalid":t.legal_id,"inq:details_righttype":Codelist("righttype",e.right[0].right_type),"inq:details_vaidsince":dateFormat_dMY(e.right[0].valid_since),"inq:details_rightsource":Codelist("rightsource",e.right[0].right_source),"inq:details_notes":e.right[0].notes})}else SettingsCtrl.onConnectionError(),showErrorMsg(null,i.json().message)},e=>{showErrorMsg(e,"")})}};export{InquieriesCtrl};